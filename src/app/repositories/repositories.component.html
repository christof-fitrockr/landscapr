<div class="container-xl mt-3">
  <!-- Connection & Repository (Collapsible) -->
  <div class="card mb-3">
    <div class="card-header d-flex justify-content-between align-items-center" (click)="isRepoCollapsed = !isRepoCollapsed" style="cursor: pointer">
      <span>
        <i class="fas" [ngClass]="isRepoCollapsed ? 'fa-chevron-right' : 'fa-chevron-down'"></i>
        Repository: <strong>{{ selectedRepo ? selectedRepo.name : 'None' }}</strong>
      </span>
      <span *ngIf="connectedUser" class="text-muted small">Connected as {{connectedUser}}</span>
    </div>
    <div class="card-body" *ngIf="!isRepoCollapsed">
        <div class="row">
            <div class="col-md-4">
                <div class="mb-3">
                    <label class="form-label">Personal Access Token</label>
                    <div class="input-group">
                        <input [(ngModel)]="pat" type="password" class="form-control" placeholder="ghp_..." />
                        <div class="input-group-append">
                            <button class="btn btn-outline-secondary" (click)="connect()" [disabled]="connecting">
                                <span *ngIf="!connecting">Connect</span>
                                <span *ngIf="connecting"><i class="fas fa-spinner fa-spin"></i></span>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="repo-list border rounded" style="max-height: 200px; overflow-y: auto;">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item repo-item list-group-item-action" *ngFor="let r of (repos$ | async)" (click)="selectRepo(r)" [class.active]="selectedRepo?.name===r.name" style="cursor: pointer">
                          <i class="fab fa-github"></i> {{r.name}}
                        </li>
                    </ul>
                </div>
            </div>
            <div class="col-md-8">
                <label class="form-label">Files</label>
                <div class="file-list border rounded" style="max-height: 240px; overflow-y: auto;">
                    <div *ngIf="!selectedRepo" class="p-3 text-muted">Select a repository.</div>
                    <div *ngIf="loadingFiles" class="p-3"><i class="fas fa-spinner fa-spin"></i> Loading...</div>
                    <ul class="list-group list-group-flush" *ngIf="selectedRepo && !loadingFiles">
                      <li class="list-group-item file-item list-group-item-action" *ngFor="let f of (files$ | async)" (click)="selectFile(f)" [class.active]="selectedFilePath===f.path" style="cursor: pointer">
                        <i class="far" [ngClass]="f.type==='dir' ? 'fa-folder' : 'fa-file'" class="me-2"></i>
                        {{f.path}}
                      </li>
                    </ul>
                </div>
                <div class="mt-2 d-flex justify-content-between">
                     <button class="btn btn-sm btn-outline-primary" (click)="loadFromGithub()" [disabled]="!selectedFilePath" title="Load selected GitHub file"><i class="fas fa-download"></i> Load</button>
                     <div class="small text-muted align-self-center">{{ selectedFilePath || 'No file selected' }}</div>
                </div>
            </div>
        </div>
    </div>
  </div>

  <!-- Workspace Card (Prominent) -->
  <div class="card mb-3 shadow-lg border-0" *ngIf="selectedRepo && selectedFilePath">
      <div class="card-header bg-light d-flex justify-content-between align-items-center">
          <h5 class="mb-0 text-dark"><i class="fas fa-laptop-code text-primary me-2"></i> Workspace</h5>
          <span class="badge badge-info p-2">{{ selectedFilePath }}</span>
      </div>
      <div class="card-body">
          <div class="row">
              <!-- Context Section -->
              <div class="col-lg-5 border-end">
                  <h6 class="text-uppercase text-muted small mb-3">Context</h6>
                  <div class="mb-3">
                      <label class="form-label small fw-bold">Current Branch</label>
                      <div class="input-group">
                          <div class="dropdown w-100" dropdown>
                              <button dropdownToggle type="button" class="btn btn-outline-dark dropdown-toggle w-100 d-flex justify-content-between align-items-center" style="min-height: 45px;">
                                  <span><i class="fas fa-code-branch me-2"></i> {{ currentBranch }}</span>
                                  <span class="caret"></span>
                              </button>
                              <ul *dropdownMenu class="dropdown-menu w-100 shadow" role="menu">
                                  <li role="menuitem" *ngFor="let b of branches">
                                      <a class="dropdown-item" href="javascript:void(0)" (click)="switchBranch(b.name)">
                                          <i class="fas fa-code-branch me-2 text-muted"></i> {{ b.name }}
                                      </a>
                                  </li>
                              </ul>
                          </div>
                      </div>
                  </div>

                  <div class="alert alert-info d-flex align-items-center mb-0" *ngIf="currentBranch === (selectedRepo?.default_branch || 'main')">
                      <i class="fas fa-eye me-3 fa-lg"></i>
                      <div>
                          <strong>View Mode</strong>
                          <div class="small">You are viewing the main branch. Start Edit Mode to make changes.</div>
                      </div>
                  </div>
                  <div class="alert alert-warning d-flex align-items-center mb-0" *ngIf="currentBranch !== (selectedRepo?.default_branch || 'main')">
                      <i class="fas fa-edit me-3 fa-lg"></i>
                      <div>
                          <strong>Edit Mode</strong>
                          <div class="small">You are working on a feature branch. Save often!</div>
                      </div>
                  </div>
              </div>

              <!-- Actions Section -->
              <div class="col-lg-7 d-flex flex-column justify-content-center align-items-center p-4">

                  <!-- Main Branch Actions -->
                  <div *ngIf="currentBranch === (selectedRepo?.default_branch || 'main')" class="w-100 text-center">
                      <h6 class="text-uppercase text-muted small mb-4">Available Actions</h6>
                      <div class="d-grid gap-3 col-8 mx-auto">
                          <button class="btn btn-primary btn-lg shadow-sm" (click)="startEditMode()">
                              <i class="fas fa-pen me-2"></i> Start Edit Mode
                          </button>
                          <button class="btn btn-outline-secondary btn-lg" (click)="loadFromGithub()">
                              <i class="fas fa-sync-alt me-2"></i> Update from Repository
                          </button>
                      </div>
                  </div>

                  <!-- Feature Branch Actions -->
                  <div *ngIf="currentBranch !== (selectedRepo?.default_branch || 'main')" class="w-100">
                       <h6 class="text-uppercase text-muted small mb-4 text-center">Branch Operations</h6>
                       <div class="row g-3 justify-content-center">
                           <div class="col-md-5">
                               <button class="btn btn-outline-primary w-100 h-100 py-3" (click)="saveToGithub()" [disabled]="saving">
                                   <div *ngIf="!saving" class="d-flex flex-column align-items-center">
                                       <i class="fas fa-save fa-2x mb-2"></i>
                                       <span>Save Changes</span>
                                   </div>
                                   <div *ngIf="saving" class="d-flex flex-column align-items-center">
                                       <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                                       <span>Saving...</span>
                                   </div>
                               </button>
                           </div>
                           <div class="col-md-5">
                               <button class="btn btn-success w-100 h-100 py-3" (click)="submitChanges()">
                                   <div class="d-flex flex-column align-items-center">
                                       <i class="fas fa-paper-plane fa-2x mb-2"></i>
                                       <span>Submit Changes</span>
                                   </div>
                               </button>
                           </div>
                       </div>
                       <div class="mt-4 text-center">
                           <button class="btn btn-link text-muted text-decoration-none" (click)="switchToMain()">
                               <i class="fas fa-times-circle me-1"></i> Discard changes and return to Main
                           </button>
                       </div>
                  </div>

              </div>
          </div>
      </div>
  </div>

  <!-- Open Pull Requests -->
  <div class="card mb-3 shadow-sm" *ngIf="selectedRepo && (pullRequests$ | async) as prs">
      <div class="card-header bg-white">
          <h5 class="mb-0 text-secondary"><i class="fas fa-code-branch"></i> Open Pull Requests</h5>
      </div>
      <div class="card-body p-0">
          <div *ngIf="prs.length === 0" class="p-3 text-muted">No open pull requests.</div>
          <ul class="list-group list-group-flush" *ngIf="prs.length > 0">
              <li class="list-group-item d-flex justify-content-between align-items-center" *ngFor="let pr of prs">
                  <div>
                      <a [href]="pr.html_url" target="_blank" rel="noopener noreferrer" class="font-weight-bold">{{ pr.title }}</a>
                      <div class="small text-muted">
                          #{{ pr.number }} opened by {{ pr.user.login }}
                      </div>
                  </div>
                  <a [href]="pr.html_url" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-outline-secondary"><i class="fas fa-external-link-alt"></i></a>
              </li>
          </ul>
      </div>
  </div>

  <!-- Local Data Actions (Secondary) -->
  <div class="card mb-3" *ngIf="selectedRepo">
      <div class="card-body py-2 d-flex justify-content-between align-items-center bg-light">
          <span class="text-muted small">Local Data Operations</span>
          <div>
            <input id="uploadJsonInput" #uploadJsonInput type="file" accept="application/json" class="d-none" (change)="uploadDocument($event.target.files)">
            <button class="btn btn-sm btn-outline-secondary me-2" (click)="download()" title="Download current data as JSON">
              <i class="fas fa-file-download"></i> Download Local
            </button>
            <button class="btn btn-sm btn-outline-secondary" (click)="uploadJsonInput.click()" title="Upload JSON to replace current data">
              <i class="fas fa-file-upload"></i> Upload Local
            </button>
          </div>
      </div>
  </div>
</div>
