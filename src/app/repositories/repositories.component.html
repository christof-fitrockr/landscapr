<div class="container-xl mt-3">
  <!-- Connection & Repository (Collapsible) -->
  <div class="card mb-3">
    <div class="card-header d-flex justify-content-between align-items-center" (click)="isRepoCollapsed = !isRepoCollapsed" style="cursor: pointer">
      <span>
        <i class="fas mr-2" [ngClass]="isRepoCollapsed ? 'fa-chevron-right' : 'fa-chevron-down'"></i>
        Repository: <strong>{{ selectedRepo ? selectedRepo.name : 'None' }}</strong>
      </span>
      <span *ngIf="connectedUser" class="text-muted small">Connected as {{connectedUser}}</span>
    </div>
    <div class="card-body" *ngIf="!isRepoCollapsed">
        <div class="row">
            <div class="col-md-4">
                <div class="mb-3">
                    <label class="form-label">Personal Access Token</label>
                    <div class="input-group">
                        <input [(ngModel)]="pat" type="password" class="form-control" placeholder="ghp_..." />
                        <div class="input-group-append">
                            <button class="btn btn-outline-secondary" (click)="connect()" [disabled]="connecting">
                                <span *ngIf="!connecting">Connect</span>
                                <span *ngIf="connecting"><i class="fas fa-spinner fa-spin"></i></span>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="repo-list border rounded" style="max-height: 200px; overflow-y: auto;">
                    <div *ngIf="connecting" class="p-3 text-center text-muted">
                        <i class="fas fa-spinner fa-spin me-2"></i>Loading repositories...
                    </div>
                    <ul class="list-group list-group-flush" *ngIf="!connecting">
                        <li class="list-group-item repo-item list-group-item-action" *ngFor="let r of (repos$ | async)" (click)="selectRepo(r)" [class.active]="selectedRepo?.name===r.name" style="cursor: pointer">
                          <i class="fab fa-github"></i> {{r.name}}
                        </li>
                    </ul>
                </div>
            </div>
            <div class="col-md-8">
                <label class="form-label">Files</label>
                <div class="file-list border rounded" style="max-height: 240px; overflow-y: auto;">
                    <div *ngIf="!selectedRepo" class="p-3 text-muted">Select a repository.</div>
                    <div *ngIf="loadingFiles" class="p-3"><i class="fas fa-spinner fa-spin"></i> Loading...</div>
                    <ul class="list-group list-group-flush" *ngIf="selectedRepo && !loadingFiles">
                      <li class="list-group-item file-item list-group-item-action" *ngFor="let f of (files$ | async)" (click)="selectFile(f)" [class.active]="selectedFilePath===f.path" style="cursor: pointer">
                        <i class="far" [ngClass]="f.type==='dir' ? 'fa-folder' : 'fa-file'" class="me-2"></i>
                        {{f.path}}
                      </li>
                    </ul>
                </div>
                <div class="mt-2 d-flex justify-content-between">
                     <button class="btn btn-sm btn-outline-primary" (click)="loadFromGithub()" [disabled]="!selectedFilePath || loadingFileContent" title="Load selected GitHub file">
                         <i class="fas" [ngClass]="loadingFileContent ? 'fa-spinner fa-spin' : 'fa-download'"></i>
                         {{ loadingFileContent ? ' Loading...' : ' Load' }}
                     </button>
                     <div class="small text-muted align-self-center">{{ selectedFilePath || 'No file selected' }}</div>
                </div>
            </div>
        </div>
    </div>
  </div>


  <!-- Statistics Card -->
  <div class="card mb-4 shadow-sm" *ngIf="selectedRepo && selectedFilePath && stats">
    <div class="card-header bg-white py-3">
      <h5 class="mb-0 fw-bold text-slate-900">
        <i class="fas fa-chart-pie mr-2"></i> Repository Statistics
      </h5>
    </div>
    <div class="card-body bg-light py-3 border-top">
      <div class="row">
        <div class="col-md-2 col-sm-4 col-6 mb-2">
          <div class="card h-100 border-0 shadow-sm">
            <div class="card-body text-center p-2">
              <i class="fas fa-map-signs text-primary mb-1"></i>
              <h4 class="fw-bold mb-0 text-slate-900">{{ stats.journeys }}</h4>
              <div class="text-muted small text-uppercase fw-bold" style="font-size: 0.65rem;">Journeys</div>
            </div>
          </div>
        </div>
        <div class="col-md-2 col-sm-4 col-6 mb-2">
          <div class="card h-100 border-0 shadow-sm">
            <div class="card-body text-center p-2">
              <i class="fas fa-project-diagram text-info mb-1"></i>
              <h4 class="fw-bold mb-0 text-slate-900">{{ stats.processes }}</h4>
              <div class="text-muted small text-uppercase fw-bold" style="font-size: 0.65rem;">Processes</div>
            </div>
          </div>
        </div>
        <div class="col-md-3 col-sm-6 col-6 mb-2">
          <div class="card h-100 border-0 shadow-sm">
            <div class="card-body text-center p-2">
              <i class="fas fa-plug text-warning mb-1"></i>
              <h4 class="fw-bold mb-0 text-slate-900">{{ stats.apis }}</h4>
              <div class="text-muted small text-uppercase fw-bold" style="font-size: 0.65rem;">APIs</div>
            </div>
          </div>
        </div>
        <div class="col-md-3 col-sm-6 col-6 mb-2">
          <div class="card h-100 border-0 shadow-sm">
            <div class="card-body text-center p-2">
              <i class="fas fa-briefcase text-secondary mb-1"></i>
              <h4 class="fw-bold mb-0 text-slate-900">{{ stats.capabilities }}</h4>
              <div class="text-muted small text-uppercase fw-bold" style="font-size: 0.65rem;">Capabilities</div>
            </div>
          </div>
        </div>
        <div class="col-md-2 col-sm-12 col-12 mb-2">
          <div class="card h-100 border-0 shadow-sm">
            <div class="card-body text-center p-2">
              <i class="fas fa-server text-danger mb-1"></i>
              <h4 class="fw-bold mb-0 text-slate-900">{{ stats.systems }}</h4>
              <div class="text-muted small text-uppercase fw-bold" style="font-size: 0.65rem;">Systems</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>


  <!-- Workspace Card (Compact Redesign) -->
  <div class="card mb-4 shadow-sm" *ngIf="selectedRepo && selectedFilePath">
    <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
      <h5 class="mb-0 fw-bold text-slate-900">
        <i class="fas fa-laptop-code mr-2"></i> Workspace
      </h5>

      <div class="d-flex align-items-center">
        <!-- Main Branch Actions -->
        <ng-container *ngIf="currentBranch === (selectedRepo?.default_branch || 'main')">
          <button class="btn btn-sm btn-primary me-2" (click)="startEditMode()" [disabled]="startingEditMode">
            <i class="fas" [ngClass]="startingEditMode ? 'fa-spinner fa-spin' : 'fa-pen-nib'"></i>
            {{ startingEditMode ? ' Starting...' : ' Start Edit Mode' }}
          </button>
        </ng-container>

        <!-- Feature Branch Actions -->
        <ng-container *ngIf="currentBranch !== (selectedRepo?.default_branch || 'main')">
          <button class="btn btn-sm btn-outline-primary me-2 shadow-sm" (click)="saveToGithub()" [disabled]="saving">
            <i class="fas" [ngClass]="saving ? 'fa-spinner fa-spin' : 'fa-cloud-upload-alt'"></i>
            {{ saving ? ' Saving...' : ' Save Changes' }}
          </button>
          <button class="btn btn-sm btn-success me-2 shadow-sm" (click)="submitChanges()" [disabled]="submitting">
            <i class="fas" [ngClass]="submitting ? 'fa-spinner fa-spin' : 'fa-paper-plane'"></i>
            {{ submitting ? ' Submitting...' : ' Submit Changes' }}
          </button>
        </ng-container>

        <!-- Shared Actions -->
        <button class="btn btn-sm btn-outline-slate me-2 shadow-sm" (click)="loadFromGithub()" [disabled]="loadingFileContent">
          <i class="fas" [ngClass]="loadingFileContent ? 'fa-spinner fa-spin' : 'fa-sync-alt'"></i>
          {{ loadingFileContent ? ' Updating...' : ' Update from Repo' }}
        </button>

        <!-- Discard (Only in Edit Mode) -->
        <button *ngIf="currentBranch !== (selectedRepo?.default_branch || 'main')"
                class="btn btn-sm btn-link text-danger text-decoration-none" (click)="switchToMain()">
          <i class="fas fa-times-circle me-1"></i> Discard
        </button>
      </div>
    </div>

    <div class="card-body bg-light py-3 border-top">
      <div class="row">
        <div class="col-md-6">
          <div class="d-flex align-items-center mb-2">
            <span class="text-muted small text-uppercase fw-bold me-3" style="min-width: 80px;">Branch</span>
            <div class="d-flex align-items-center">
              <span class="py-1 px-2 border rounded bg-white shadow-sm small fw-bold">
                <i class="fas fa-code-branch me-2 text-primary"></i> {{ currentBranch }}
                <span *ngIf="currentBranch === (selectedRepo?.default_branch || 'main')" class="badge bg-light text-slate-500 border ms-2 fw-normal">default</span>
              </span>
            </div>
          </div>
          <div class="d-flex align-items-center">
            <span class="text-muted small text-uppercase fw-bold me-3" style="min-width: 80px;">File</span>
            <code class="text-primary fw-bold small">{{ selectedFilePath }}</code>
          </div>
        </div>
        <div class="col-md-6 border-md-start">
          <div class="d-flex align-items-center mb-2">
            <span class="text-muted small text-uppercase fw-bold me-3" style="min-width: 80px;">Mode</span>
            <span class="badge"
              [class.bg-info-soft]="currentBranch === (selectedRepo?.default_branch || 'main')"
              [class.text-info]="currentBranch === (selectedRepo?.default_branch || 'main')"
              [class.bg-warning-soft]="currentBranch !== (selectedRepo?.default_branch || 'main')"
              [class.text-warning]="currentBranch !== (selectedRepo?.default_branch || 'main')">
              {{ currentBranch === (selectedRepo?.default_branch || 'main') ? 'VIEW' : 'EDIT' }}
            </span>
            <span class="ms-3 small text-slate-500">
              <ng-container *ngIf="currentBranch === (selectedRepo?.default_branch || 'main')">
                Viewing main branch
              </ng-container>
              <ng-container *ngIf="currentBranch !== (selectedRepo?.default_branch || 'main')">
                Active feature branch
              </ng-container>
            </span>
          </div>
          <div class="d-flex align-items-center">
            <span class="text-muted small text-uppercase fw-bold me-3" style="min-width: 80px;">Status</span>
            <span class="small text-slate-500 font-italic">
              <ng-container *ngIf="currentBranch === (selectedRepo?.default_branch || 'main')">
                Start Edit Mode to make changes.
              </ng-container>
              <ng-container *ngIf="currentBranch !== (selectedRepo?.default_branch || 'main')">
                Unsaved changes will be lost if you switch branches.
              </ng-container>
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Open Pull Requests -->
  <div class="card mb-3 shadow-sm" *ngIf="selectedRepo">
      <div class="card-header bg-white">
          <h5 class="mb-0 text-secondary"><i class="fas fa-code-branch mr-2"></i> Open Pull Requests</h5>
      </div>
      <div class="card-body p-0">
          <div *ngIf="loadingPRs" class="p-3 text-center text-muted">
              <i class="fas fa-spinner fa-spin me-2"></i>Loading pull requests...
          </div>
          <ng-container *ngIf="!loadingPRs">
              <div *ngIf="(pullRequests$ | async)?.length === 0" class="p-3 text-muted">No open pull requests.</div>
              <ul class="list-group list-group-flush" *ngIf="(pullRequests$ | async) as prs">
                  <li class="list-group-item d-flex justify-content-between align-items-center" *ngFor="let pr of prs">
                      <div>
                          <a [href]="pr.html_url" target="_blank" rel="noopener noreferrer" class="fw-bold">{{ pr.title }}</a>
                          <div class="small text-muted">
                              #{{ pr.number }} opened by {{ pr.user.login }}
                          </div>
                      </div>
                      <a [href]="pr.html_url" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-outline-secondary"><i class="fas fa-external-link-alt"></i></a>
                  </li>
              </ul>
          </ng-container>
      </div>
  </div>

  <!-- Local Data Actions (Secondary) -->
  <div class="card mb-3" *ngIf="selectedRepo">
      <div class="card-body py-2 d-flex justify-content-between align-items-center bg-light">
          <span class="text-muted small">Local Data Operations</span>
          <div>
            <input id="uploadJsonInput" #uploadJsonInput type="file" accept="application/json" class="d-none" (change)="uploadDocument($event.target.files)">
            <button class="btn btn-sm btn-outline-primary me-2" (click)="exportToPpt()" title="Export all data to PowerPoint">
              <i class="fas fa-file-powerpoint"></i> Export PPT
            </button>
            <button class="btn btn-sm btn-outline-secondary me-2" (click)="download()" title="Download current data as JSON">
              <i class="fas fa-file-download"></i> Download Local
            </button>
            <button class="btn btn-sm btn-outline-secondary" (click)="uploadJsonInput.click()" title="Upload JSON to replace current data">
              <i class="fas fa-file-upload"></i> Upload Local
            </button>
          </div>
      </div>
  </div>
</div>
