<div class="container-fluid position-relative h-100 overflow-hidden d-flex flex-column p-0">

  <div class="d-flex justify-content-between align-items-center mb-4 px-4 pt-4" *ngIf="processId">
    <div class="btn-toolbar" role="toolbar">
      <div class="btn-group shadow-sm mr-2">
        <button class="btn btn-outline-secondary" (click)="onWheel({deltaY: -1, preventDefault: noop})" title="Zoom In"><i class="fas fa-search-plus"></i></button>
        <button class="btn btn-outline-secondary" (click)="onWheel({deltaY: 1, preventDefault: noop})" title="Zoom Out"><i class="fas fa-search-minus"></i></button>
      </div>
    </div>
    <div class="text-right">
      <h2 class="m-0 font-weight-bold text-uppercase text-gray-400">Swimlane View</h2>
    </div>
  </div>

  <div class="canvas-container flex-grow-1 w-100 position-relative" #canvasContainer>
    <canvas id="canvas" #canvas class="canvas"
            (mousedown)="onMouseDown($event)"
            (mousemove)="onMouseMove($event)"
            (mouseup)="onMouseUp($event)"
            (wheel)="onWheel($event)"
            (click)="onCanvasClick($event)"></canvas>

    <canvas id="hiddenCanvas" #hiddenCanvas style="display:none;">
      Your browser does not support the HTML5 canvas tag.</canvas>
  </div>

  <div class="side-panel shadow-lg" [class.open]="selectedItem">
    <div class="side-panel-header d-flex justify-content-between align-items-center bg-gray-800  p-3">
      <h5 class="mb-0">{{selectedItem?.title || 'Properties'}}</h5>
      <button type="button" class="btn btn-sm btn-link " (click)="selectedItem = null">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="side-panel-toolbar p-2 border-bottom d-flex gap-2 bg-white" *ngIf="selectedItem">
      <button class="btn btn-sm btn-outline-primary" (click)="openSelectedItem()">
        Open
      </button>
      <button class="btn btn-sm btn-outline-primary" (click)="openSelectedItemInNewTab()">
        <i class="bi bi-box-arrow-up-right me-1"></i> Open in New Tab
      </button>
      <button class="btn btn-sm btn-outline-primary" (click)="viewSelectedItem()" *ngIf="selectedProcess">
        <i class="bi bi-eye me-1"></i> View
      </button>
    </div>
    <div class="side-panel-body p-3 overflow-auto" *ngIf="selectedItem">
      <div *ngIf="selectedProcess">
        <p class="description-text"><strong>Description:</strong> {{selectedProcess.description}}</p>
        <p><strong>Role:</strong> {{Role[selectedProcess.role]}}</p>
        <p><strong>Status:</strong> {{Status[selectedProcess.status]}}</p>
        <div *ngIf="selectedProcess.apiCallIds?.length > 0">
            <h6>API Calls</h6>
            <ul>
                <li *ngFor="let apiId of selectedProcess.apiCallIds">{{apiCallMap.get(apiId)?.name}}</li>
            </ul>
        </div>
        <hr>
        <h6>Comments</h6>
        <div class="comments-section">
          <div class="add-comment mb-4">
            <div class="form-group">
              <textarea class="form-control mb-2" rows="3" [(ngModel)]="newCommentText" placeholder="Write a comment..."></textarea>
            </div>
            <div class="text-right">
              <button class="btn btn-primary btn-sm" [disabled]="!newCommentText.trim()" (click)="addComment()">Add Comment</button>
            </div>
          </div>
          <div class="comments-list">
            <div *ngIf="!selectedProcess.comments || selectedProcess.comments.length === 0" class="text-center text-muted mt-5">
              <p>No comments yet.</p>
            </div>
            <div *ngFor="let comment of selectedProcess.comments" class="comment-item card mb-2">
              <div class="card-body p-2">
                <div class="d-flex justify-content-between align-items-center mb-1">
                  <div>
                    <strong class="mr-2">{{comment.username}}</strong>
                    <small class="text-muted">{{comment.timestamp | date:'short'}}</small>
                  </div>
                  <div class="actions">
                    <button class="btn btn-link btn-xs text-secondary p-0 mr-2" title="Edit" (click)="startEdit(comment)">
                      <i class="fas fa-pencil-alt"></i>
                    </button>
                    <button class="btn btn-link btn-xs text-danger p-0" title="Delete" (click)="deleteComment(comment)">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </div>
                <div *ngIf="editingCommentId !== comment.id" class="comment-text">
                  {{comment.text}}
                </div>
                <div *ngIf="editingCommentId === comment.id" class="edit-box mt-2">
                  <textarea class="form-control mb-2" rows="2" [(ngModel)]="editingText"></textarea>
                  <div class="text-right">
                    <button class="btn btn-secondary btn-xs mr-1" (click)="cancelEdit()">Cancel</button>
                    <button class="btn btn-success btn-xs" (click)="saveEdit(comment)">Save</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div *ngIf="selectedApiCall">
        <p class="description-text"><strong>Description:</strong> {{selectedApiCall.description}}</p>
        <p><strong>Status:</strong> {{ApiImplementationStatus[selectedApiCall.implementationStatus]}}</p>
        <p><strong>Input:</strong> {{selectedApiCall.input}}</p>
        <p><strong>Output:</strong> {{selectedApiCall.output}}</p>
      </div>
    </div>
  </div>
</div>
