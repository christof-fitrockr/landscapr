<div class="container-fluid h-100">
  <div class="card shadow mb-4 h-100 flex-column-fill">

    <div class="card-header py-3 d-flex flex-column">
      <div class="d-flex flex-row align-items-center justify-content-between w-100">
        <div class="btn-toolbar" role="toolbar" aria-label="Editor tools">
          <div class="btn-group mr-2" role="group" aria-label="First group">
            <a class="btn btn-secondary" title="Edit" [routerLink]="['/journeys/edit', journeyId, 'base']"><i class="fas fa-edit"></i></a>
            <a class="btn btn-secondary" title="List" routerLink="/journeys/list"><i class="fas fa-list"></i></a>
          </div>
          <div class="btn-group mr-2" role="group" aria-label="Tool buttons">
            <button class="btn btn-secondary" [ngClass]="{'active': activeTool==='select'}" (click)="setTool('select')" title="Select">
              <i class="fas fa-mouse-pointer"></i>
            </button>
            <button class="btn btn-secondary" [ngClass]="{'active': activeTool==='process'}" (click)="setTool('process')" title="Process">
              <i class="fas fa-cube"></i>
            </button>
            <button class="btn btn-secondary" [ngClass]="{'active': activeTool==='decision'}" (click)="setTool('decision')" title="Decision">
              <i class="fas fa-code-branch"></i>
            </button>
            <button class="btn btn-secondary" [ngClass]="{'active': activeTool==='group'}" (click)="setTool('group')" title="Group Box">
              <i class="fas fa-object-group"></i>
            </button>
            <button class="btn btn-secondary" [ngClass]="{'active': activeTool==='connector'}" (click)="setTool('connector')" title="Connector">
              <i class="fas fa-project-diagram"></i>
            </button>
            <div class="btn-group ml-2">
              <button class="btn btn-secondary" (click)="undo()" [disabled]="!canUndo()" title="Undo (Ctrl+Z)">
                <i class="fas fa-undo"></i>
              </button>
              <button class="btn btn-secondary" (click)="redo()" [disabled]="!canRedo()" title="Redo (Ctrl+Y)">
                <i class="fas fa-redo"></i>
              </button>
            </div>
            <div class="btn-group ml-2">
              <button class="btn btn-outline-secondary" (click)="showCommentsPanel = !showCommentsPanel" [class.active]="showCommentsPanel" title="Comments">
                <i class="fas fa-comment-alt"></i>
              </button>
              <button class="btn btn-outline-secondary" (click)="exportToPpt()" title="Export to PowerPoint">
                <i class="fas fa-file-powerpoint"></i>
              </button>
            </div>
          </div>
          <div class="ml-2" *ngIf="activeTool==='process'">
            <div class="input-group input-group-sm align-items-stretch">
              <div class="input-group-prepend">
                <span class="input-group-text">Process</span>
              </div>
              <div class="process-select">
                <ng-select
                  [items]="processes"
                  bindLabel="name"
                  bindValue="id"
                  [(ngModel)]="selectedProcessId"
                  [clearable]="true"
                  [searchable]="true"
                  dropdownPosition="bottom"
                  appendTo="body"
                  placeholder="Select process...">
                </ng-select>
              </div>
              <div class="input-group-append">
                <button class="btn btn-outline-primary" type="button" (click)="openNewProcessModal()">New Process</button>
              </div>
            </div>
          </div>
        </div>
        <div class="text-right">
          <div class="m-0 font-weight-bold text-uppercase text-gray-400">Journey Editor</div>
          <div class="small text-muted" *ngIf="journeyName">{{journeyName}}</div>
        </div>
      </div>
      <div class="legend small text-muted mt-2">
        Tips: Mouse wheel to zoom, right mouse or Shift+drag to pan. Click canvas with a tool to place. Delete key removes selection.
      </div>
    </div>

    <div class="card-body p-0 flex-column-fill">
      <div class="journey-editor">
        <div class="canvas-wrapper" (contextmenu)="$event.preventDefault()">
          <svg #svgEl class="canvas" tabindex="0"
               (mousedown)="onCanvasMouseDown($event)"
               (mousemove)="onCanvasMouseMove($event)"
               (mouseup)="onCanvasMouseUp($event)"
               (wheel)="onWheel($event)">
            <!-- Grid background using patterns -->
            <defs>
              <pattern id="smallGrid" width="20" height="20" patternUnits="userSpaceOnUse">
                <path d="M 20 0 L 0 0 0 20" fill="none" stroke="var(--grid-color-small)" stroke-width="1" />
              </pattern>
              <pattern id="grid" width="100" height="100" patternUnits="userSpaceOnUse">
                <rect width="100" height="100" fill="url(#smallGrid)" />
                <path d="M 100 0 L 0 0 0 100" fill="none" stroke="var(--grid-color-large)" stroke-width="1" />
              </pattern>
              <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
                <polygon points="0 0, 10 3.5, 0 7" fill="var(--arrow-color)" />
              </marker>
            </defs>
            <rect x="-100000" y="-100000" width="200000" height="200000" fill="url(#grid)"></rect>

            <!-- Pan/Zoom group -->
            <g [attr.transform]="'translate(' + panX + ',' + panY + ') scale(' + zoom + ')'"><!-- World space -->

              <!-- Background groups (rendered behind edges and other nodes) -->
              <g class="nodes">
                <ng-container *ngFor="let n of nodes">
                  <g *ngIf="n.type === 'group'" [attr.transform]="'translate(' + n.x + ',' + n.y + ')'" (dblclick)="onGroupDblClick(n, $event)"><!-- group node -->
                    <rect [attr.width]="n.width" [attr.height]="n.height" class="node group" [ngClass]="{'selected': n.selected}"></rect>
                    <text x="8" y="16" class="group-label">{{n.label}}</text>

                    <!-- Resize handles when selected -->
                    <g *ngIf="n.selected">
                      <!-- corners -->
                      <rect class="resize-handle handle-nw" [attr.x]="-4" [attr.y]="-4" width="8" height="8"
                            (mousedown)="onResizeHandleMouseDown(n, 'nw', $event)"></rect>
                      <rect class="resize-handle handle-ne" [attr.x]="n.width-4" [attr.y]="-4" width="8" height="8"
                            (mousedown)="onResizeHandleMouseDown(n, 'ne', $event)"></rect>
                      <rect class="resize-handle handle-se" [attr.x]="n.width-4" [attr.y]="n.height-4" width="8" height="8"
                            (mousedown)="onResizeHandleMouseDown(n, 'se', $event)"></rect>
                      <rect class="resize-handle handle-sw" [attr.x]="-4" [attr.y]="n.height-4" width="8" height="8"
                            (mousedown)="onResizeHandleMouseDown(n, 'sw', $event)"></rect>
                      <!-- edges -->
                      <rect class="resize-handle handle-n" [attr.x]="n.width/2-4" [attr.y]="-4" width="8" height="8"
                            (mousedown)="onResizeHandleMouseDown(n, 'n', $event)"></rect>
                      <rect class="resize-handle handle-s" [attr.x]="n.width/2-4" [attr.y]="n.height-4" width="8" height="8"
                            (mousedown)="onResizeHandleMouseDown(n, 's', $event)"></rect>
                      <rect class="resize-handle handle-e" [attr.x]="n.width-4" [attr.y]="n.height/2-4" width="8" height="8"
                            (mousedown)="onResizeHandleMouseDown(n, 'e', $event)"></rect>
                      <rect class="resize-handle handle-w" [attr.x]="-4" [attr.y]="n.height/2-4" width="8" height="8"
                            (mousedown)="onResizeHandleMouseDown(n, 'w', $event)"></rect>
                    </g>
                  </g>
                </ng-container>
              </g>

              <!-- Edges (above groups, below foreground nodes) -->
              <g class="edges">
                <g *ngFor="let e of edges">
                  <!-- Wide invisible stroke to improve hit area for selection and dblclick -->
                  <path [attr.d]="edgePath(e)"
                        style="fill: none; stroke: transparent; stroke-width: 32; vector-effect: non-scaling-stroke; pointer-events: stroke;"
                        (mousedown)="onEdgeMouseDown(e, $event)"
                        (dblclick)="onEdgeDblClick(e, $event)" />
                  <!-- Visible edge -->
                  <path [attr.d]="edgePath(e)" class="edge" [ngClass]="{'selected': e.selected}" [attr.marker-end]="'url(#arrowhead)'" />

                  <!-- Endpoint handles when selected -->
                  <g *ngIf="e.selected">
                    <circle [attr.cx]="edgeEndpoints(e).p1.x" [attr.cy]="edgeEndpoints(e).p1.y" r="4" class="endpoint-handle"
                            (mousedown)="onEndpointHandleMouseDown(e, 'from', $event)"></circle>
                    <circle [attr.cx]="edgeEndpoints(e).p2.x" [attr.cy]="edgeEndpoints(e).p2.y" r="4" class="endpoint-handle"
                            (mousedown)="onEndpointHandleMouseDown(e, 'to', $event)"></circle>
                  </g>

                  <text *ngIf="e.label"
                        [attr.x]="edgeLabelPosition(e).x"
                        [attr.y]="edgeLabelPosition(e).y"
                        [attr.transform]="edgeLabelTransform(e)"
                        text-anchor="middle"
                        dominant-baseline="middle"
                        class="edge-label">{{e.label}}</text>
                </g>
              </g>

                <!-- Foreground layer: Processes and Decisions -->
                <g class="nodes">
                <ng-container *ngFor="let n of nodes">
                  <g *ngIf="n.type !== 'group'" [attr.transform]="'translate(' + n.x + ',' + n.y + ')'"><!-- non-group node -->
                    <ng-container [ngSwitch]="n.type">
                      <g *ngSwitchCase="'process'" (dblclick)="onProcessDblClick(n, $event)">
                        <rect [attr.width]="n.width" [attr.height]="n.height" rx="8" ry="8" class="node process"
                              [ngClass]="{'selected': n.selected, 'draft': isProcessDraft(n)}"
                              [attr.fill]="getNodeColor(n)"
                              [attr.stroke-dasharray]="isProcessDraft(n) ? '5,5' : 'none'"></rect>
                        <text [attr.x]="n.width/2" [attr.y]="n.height/2" dominant-baseline="middle" text-anchor="middle">{{n.label}}</text>
                        <text *ngIf="isProcessDraft(n)" [attr.x]="5" [attr.y]="5" font-size="8" font-style="italic" dominant-baseline="hanging" text-anchor="start" fill="var(--node-text)">DRAFT</text>

                        <!-- Resize handles when selected -->
                        <g *ngIf="n.selected">
                          <!-- corners -->
                          <rect class="resize-handle handle-nw" [attr.x]="-4" [attr.y]="-4" width="8" height="8"
                                (mousedown)="onResizeHandleMouseDown(n, 'nw', $event)"></rect>
                          <rect class="resize-handle handle-ne" [attr.x]="n.width-4" [attr.y]="-4" width="8" height="8"
                                (mousedown)="onResizeHandleMouseDown(n, 'ne', $event)"></rect>
                          <rect class="resize-handle handle-se" [attr.x]="n.width-4" [attr.y]="n.height-4" width="8" height="8"
                                (mousedown)="onResizeHandleMouseDown(n, 'se', $event)"></rect>
                          <rect class="resize-handle handle-sw" [attr.x]="-4" [attr.y]="n.height-4" width="8" height="8"
                                (mousedown)="onResizeHandleMouseDown(n, 'sw', $event)"></rect>
                          <!-- edges -->
                          <rect class="resize-handle handle-n" [attr.x]="n.width/2-4" [attr.y]="-4" width="8" height="8"
                                (mousedown)="onResizeHandleMouseDown(n, 'n', $event)"></rect>
                          <rect class="resize-handle handle-s" [attr.x]="n.width/2-4" [attr.y]="n.height-4" width="8" height="8"
                                (mousedown)="onResizeHandleMouseDown(n, 's', $event)"></rect>
                          <rect class="resize-handle handle-e" [attr.x]="n.width-4" [attr.y]="n.height/2-4" width="8" height="8"
                                (mousedown)="onResizeHandleMouseDown(n, 'e', $event)"></rect>
                          <rect class="resize-handle handle-w" [attr.x]="-4" [attr.y]="n.height/2-4" width="8" height="8"
                                (mousedown)="onResizeHandleMouseDown(n, 'w', $event)"></rect>
                        </g>
                      </g>
                      <g *ngSwitchCase="'decision'" (dblclick)="onDecisionDblClick(n, $event)">
                        <!-- Diamond: rotate a smaller square around its center -->
                        <rect [attr.width]="n.width" [attr.height]="n.height"
                              [attr.transform]="'translate(' + (n.width/2) + ',' + (n.height/2) + ') rotate(45) translate(' + (-n.width/2) + ',' + (-n.height/2) + ')'"
                              class="node decision" [ngClass]="{'selected': n.selected}"></rect>
                        <!-- Label below the diamond -->
                        <text [attr.x]="n.width/2" [attr.y]="n.height + 12" text-anchor="middle" class="decision-label">{{n.label}}</text>
                      </g>
                    </ng-container>
                  </g>
                </ng-container>
              </g>
            </g>
          </svg>
        </div>

        <div class="swimlane-overlay" *ngIf="selectedProcessIdForSwimlane">
          <div class="swimlane-overlay-header d-flex justify-content-between align-items-center p-2 bg-dark text-white">
            <h5 class="mb-0">Process Swimlane View</h5>
            <button type="button" class="btn btn-sm btn-outline-light" (click)="selectedProcessIdForSwimlane = null">
              <i class="fas fa-times"></i> Close
            </button>
          </div>
          <div class="swimlane-overlay-body">
            <app-swimlane-view [processId]="selectedProcessIdForSwimlane"></app-swimlane-view>
          </div>
        </div>
      </div>
    </div>

  </div>

  <app-comments-panel *ngIf="showCommentsPanel"
                      [comments]="journey?.comments"
                      title="Journey Comments"
                      (commentsChange)="updateJourneyComments($event)"
                      (close)="showCommentsPanel = false">
  </app-comments-panel>
</div>

